# SVD函数共享内存支持

## 概述

这个SVD函数已经支持共享内存数据传输，可以显著提高大数据量处理时的性能。

## 文件结构

```
svd__start/
├── main.py              # 原始主函数（HTTP模式）
├── main_shm.py          # 支持共享内存的主函数
├── blocks/block_0/
│   ├── main.py          # 原始Block函数（HTTP模式）
│   └── main_shm.py      # 支持共享内存的Block函数
├── test_shm.py          # 共享内存功能测试脚本
├── data.npy             # 预生成的测试数据（16MB）
└── README_SHM.md        # 本文档
```

## 功能特性

### 1. 自动模式切换
- 如果共享内存可用，自动使用共享内存模式
- 如果共享内存不可用，自动回退到HTTP模式
- 无需手动配置

### 2. 数据流优化
- **输入**: 随机生成矩阵 (8192×512)
- **处理**: SVD分解
- **输出**: 16个矩阵块通过共享内存传输

### 3. 性能提升
- 减少网络传输开销
- 零拷贝数据传输
- 降低序列化/反序列化成本

## 使用方法

### 1. 测试共享内存功能
```bash
cd /proxy
python3 test_shm.py
```

### 2. 运行共享内存版本的主函数
```bash
cd /proxy
python3 main_shm.py
```

### 3. 运行共享内存版本的Block函数
```bash
cd /proxy
python3 blocks/block_0/main_shm.py
```

## 数据格式

### 共享内存包描述符
```json
{
    "packet_id": 123,
    "data_size": 1048576,
    "function_id": 1,
    "block_id": 0,
    "timestamp": 1640995200000000
}
```

### 输出数据
- `matrix_shm`: 主函数输出的矩阵块描述符
- `matrix_block_shm`: Block函数输出的矩阵块描述符
- `save_db`: 执行时间信息

## 性能对比

| 模式 | 数据传输方式 | 适用场景 |
|------|-------------|----------|
| HTTP模式 | 网络传输 | 小数据量，跨网络 |
| 共享内存模式 | 内存直接访问 | 大数据量，同机部署 |

## 故障排除

### 1. 共享内存不可用
```
警告: 共享内存模块不可用，将使用HTTP模式
```
**解决方案**: 检查容器是否配置了共享内存支持

### 2. 共享内存池初始化失败
```
共享内存池初始化失败，回退到HTTP模式
```
**解决方案**: 检查宿主机是否已创建共享内存池

### 3. 包分配失败
```
无法分配共享内存包
```
**解决方案**: 检查共享内存池是否已满

## 配置要求

### 容器配置
```bash
docker run --ipc=host -v /dev/shm:/dev/shm ...
```

### 共享内存大小
- 默认: 100MB
- 可通过配置文件调整

## 监控和调试

### 日志输出
- 共享内存操作状态
- 数据传输大小和包ID
- 执行时间统计

### 性能指标
- SVD计算时间
- 数据传输时间
- 内存使用情况



